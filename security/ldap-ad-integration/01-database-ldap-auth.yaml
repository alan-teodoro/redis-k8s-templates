---
# Redis Enterprise Database with LDAP Authentication (Samba AD)
#
# ============================================================================
# ⚠️ IMPORTANT: LDAP Roles and ACLs CANNOT be configured via Kubernetes YAML
# ============================================================================
#
# The RedisEnterpriseDatabase CRD does NOT support:
#   ❌ Creating ACLs directly in YAML (no aclRules field exists)
#   ❌ Creating Roles directly in YAML (no roles field exists)
#   ❌ Mapping LDAP groups to Roles in YAML
#
# You MUST use the Redis Enterprise REST API or UI to:
#   ✅ Create ACLs (Access Control Lists)
#   ✅ Create Roles and map them to LDAP groups
#   ✅ Bind Roles to ACLs for this database
#
# See API-ROLES-ACLS.md for complete REST API examples and automation script.
#
# ============================================================================
# Deployment Workflow:
# ============================================================================
# 1. Deploy this database (creates with default user authentication)
# 2. Create ACLs via REST API (see API-ROLES-ACLS.md)
#    - admin-acl: allkeys +@all
#    - developer-acl: allkeys +@all -@dangerous
#    - viewer-acl: allkeys +@read
# 3. Create Roles via REST API and map to LDAP groups:
#    - redis-admins-role → CN=Redis-Admins,CN=Users,DC=redis,DC=training,DC=local
#    - redis-developers-role → CN=Redis-Developers,CN=Users,DC=redis,DC=training,DC=local
#    - redis-viewers-role → CN=Redis-Viewers,CN=Users,DC=redis,DC=training,DC=local
# 4. Bind Roles to ACLs for this database via REST API
# 5. Test LDAP authentication
#
# The rolesPermissions field below is COMMENTED OUT because:
# - It only references existing Roles and ACLs (created via API/UI)
# - Roles and ACLs must exist before you can reference them
# - This is a limitation of the Redis Enterprise Kubernetes operator
# ============================================================================
---
apiVersion: app.redislabs.com/v1alpha1
kind: RedisEnterpriseDatabase
metadata:
  name: redis-db-ldap
  namespace: redis-enterprise
spec:
  memorySize: 2GB

  # Enable replication for HA
  replication: true

  # Database port
  databasePort: 12000

  # Default user authentication (fallback)
  # The secret will be created automatically with name: redb-redis-db-ldap
  # To disable default user and use LDAP only, set defaultUser: false
  defaultUser: true

  # Redis Enterprise Roles and ACLs binding
  # IMPORTANT: Roles and ACLs must be created via Redis Enterprise API or UI first!
  # Example (commented out - requires Roles/ACLs to be created first):
  # rolesPermissions:
  #   - type: redis-enterprise
  #     role: "redis-admins-role"      # Role name from Redis Enterprise
  #     acl: "admin-acl"                # ACL name from Redis Enterprise
  #   - type: redis-enterprise
  #     role: "redis-developers-role"
  #     acl: "developer-acl"
  #   - type: redis-enterprise
  #     role: "redis-viewers-role"
  #     acl: "viewer-acl"

---
# Deployment and Testing Instructions
---

# ============================================================================
# DEPLOYMENT STEPS
# ============================================================================

# STEP 1: Deploy the database
# kubectl apply -f 01-database-ldap-auth.yaml

# STEP 2: Wait for database to be ready
# kubectl get redb redis-db-ldap -n redis-enterprise -w
# Wait for STATUS: active

# STEP 3: Get the default database password (auto-generated secret)
# kubectl get secret redb-redis-db-ldap -n redis-enterprise -o jsonpath='{.data.password}' | base64 -d
# Save this password for testing

# ============================================================================
# CONFIGURE LDAP AUTHENTICATION (via Redis Enterprise API)
# ============================================================================

# LDAP is already configured at the REC level (00-rec-with-ldap.yaml)
# Now you need to create Roles and ACLs via the Redis Enterprise API

# IMPORTANT: See detailed API documentation in API-ROLES-ACLS.md

# Quick Start with API:
# 1. Get admin credentials:
#    kubectl get secret rec -n redis-enterprise -o jsonpath='{.data.username}' | base64 -d
#    kubectl get secret rec -n redis-enterprise -o jsonpath='{.data.password}' | base64 -d
#
# 2. Port-forward to API:
#    kubectl port-forward svc/rec 9443:9443 -n redis-enterprise
#
# 3. Create ACLs (see API-ROLES-ACLS.md for full examples):
#    curl -k -u "admin:password" -X POST https://localhost:9443/v1/acls \
#      -H "Content-Type: application/json" \
#      -d '{"name": "admin-acl", "acl": "allkeys +@all"}'
#
# 4. Create Roles and map to LDAP groups:
#    curl -k -u "admin:password" -X POST https://localhost:9443/v1/roles \
#      -H "Content-Type: application/json" \
#      -d '{
#        "name": "redis-admins-role",
#        "management": "admin",
#        "ldap_groups": ["CN=Redis-Admins,CN=Users,DC=redis,DC=training,DC=local"]
#      }'
#
# 5. Bind Roles to ACLs for the database (see API-ROLES-ACLS.md for details)
#
# For complete API examples and automation script, see:
# → API-ROLES-ACLS.md

# ============================================================================
# TESTING
# ============================================================================

# STEP 1: Port-forward to database
# kubectl port-forward svc/redis-db-ldap 12000:12000 -n redis-enterprise

# STEP 2: Test with default user (using password from STEP 3 above)
# redis-cli -h localhost -p 12000 --user default --pass <password-from-secret> PING
# Expected: PONG

# STEP 3: Test with LDAP user redis-admin (after configuring Roles/ACLs)
# redis-cli -h localhost -p 12000 --user redis-admin --pass RedisAdmin123! PING
# Expected: PONG

# STEP 4: Test write with redis-admin
# redis-cli -h localhost -p 12000 --user redis-admin --pass RedisAdmin123! SET test:admin "value"
# Expected: OK

# STEP 5: Test with redis-dev1 (after configuring Roles/ACLs)
# redis-cli -h localhost -p 12000 --user redis-dev1 --pass RedisDev123! SET test:dev "value"
# Expected: OK

# STEP 6: Test dangerous command with redis-dev1 (should fail)
# redis-cli -h localhost -p 12000 --user redis-dev1 --pass RedisDev123! FLUSHALL
# Expected: (error) NOPERM this user has no permissions to run the 'flushall' command

# STEP 7: Test with redis-viewer1 (after configuring Roles/ACLs)
# redis-cli -h localhost -p 12000 --user redis-viewer1 --pass RedisView123! GET test:admin
# Expected: "value"

# STEP 8: Test write with redis-viewer1 (should fail)
# redis-cli -h localhost -p 12000 --user redis-viewer1 --pass RedisView123! SET test:fail "value"
# Expected: (error) NOPERM this user has no permissions to run the 'set' command

