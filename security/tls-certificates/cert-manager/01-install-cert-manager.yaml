---
# ⚠️ DOCUMENTATION FILE - DO NOT APPLY DIRECTLY ⚠️
#
# This file contains installation instructions and examples.
# DO NOT run: kubectl apply -f 01-install-cert-manager.yaml
#
# Instead, use the official cert-manager installation URL:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
#
# Or see Method 2 and Method 3 below for Helm installation options.
#
# ============================================================================
#
# Install cert-manager on Kubernetes
#
# cert-manager is a Kubernetes-native certificate management controller
# that automates the issuance and renewal of TLS certificates.
#
# This file provides installation instructions and verification steps.
#
# Official Documentation: https://cert-manager.io/docs/installation/

---
# Method 1: Install using kubectl (Recommended)
#
# This method installs cert-manager CRDs and controller in one command.
#
# Command:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
#
# Verify installation:
#   kubectl get pods -n cert-manager
#
# Expected output:
#   NAME                                       READY   STATUS    RESTARTS   AGE
#   cert-manager-7d9f4d88d-xxxxx               1/1     Running   0          1m
#   cert-manager-cainjector-7d9f4d88d-xxxxx    1/1     Running   0          1m
#   cert-manager-webhook-7d9f4d88d-xxxxx       1/1     Running   0          1m

---
# Method 2: Install using Helm
#
# This method provides more control over cert-manager configuration.
#
# Add cert-manager Helm repository:
#   helm repo add jetstack https://charts.jetstack.io
#   helm repo update
#
# Install cert-manager:
#   helm install cert-manager jetstack/cert-manager \
#     --namespace cert-manager \
#     --create-namespace \
#     --version v1.13.3 \
#     --set installCRDs=true \
#     --set global.leaderElection.namespace=cert-manager
#
# Verify installation:
#   helm list -n cert-manager
#   kubectl get pods -n cert-manager

---
# Method 3: Install with custom configuration (Helm values)
#
# Create values.yaml:
#   cat > cert-manager-values.yaml <<EOF
#   installCRDs: true
#   
#   global:
#     leaderElection:
#       namespace: cert-manager
#   
#   # Resource limits
#   resources:
#     requests:
#       cpu: 10m
#       memory: 32Mi
#     limits:
#       cpu: 100m
#       memory: 128Mi
#   
#   # Webhook configuration
#   webhook:
#     resources:
#       requests:
#         cpu: 10m
#         memory: 32Mi
#       limits:
#         cpu: 100m
#         memory: 128Mi
#   
#   # CA Injector configuration
#   cainjector:
#     resources:
#       requests:
#         cpu: 10m
#         memory: 32Mi
#       limits:
#         cpu: 100m
#         memory: 128Mi
#   
#   # Prometheus monitoring
#   prometheus:
#     enabled: true
#     servicemonitor:
#       enabled: true
#   EOF
#
# Install with custom values:
#   helm install cert-manager jetstack/cert-manager \
#     --namespace cert-manager \
#     --create-namespace \
#     --version v1.13.3 \
#     -f cert-manager-values.yaml

---
# Verification Steps
#
# 1. Check cert-manager pods are running:
#    kubectl get pods -n cert-manager
#
# 2. Check cert-manager CRDs are installed:
#    kubectl get crd | grep cert-manager
#
#    Expected CRDs:
#    - certificaterequests.cert-manager.io
#    - certificates.cert-manager.io
#    - challenges.acme.cert-manager.io
#    - clusterissuers.cert-manager.io
#    - issuers.cert-manager.io
#    - orders.acme.cert-manager.io
#
# 3. Check cert-manager version:
#    kubectl get deployment -n cert-manager cert-manager \
#      -o jsonpath='{.spec.template.spec.containers[0].image}'
#
# 4. Check cert-manager logs:
#    kubectl logs -n cert-manager -l app=cert-manager
#
# 5. Test cert-manager with a self-signed certificate:
#    kubectl apply -f - <<EOF
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: test-selfsigned
#    spec:
#      selfSigned: {}
#    ---
#    apiVersion: cert-manager.io/v1
#    kind: Certificate
#    metadata:
#      name: test-cert
#      namespace: default
#    spec:
#      secretName: test-cert-secret
#      issuerRef:
#        name: test-selfsigned
#        kind: ClusterIssuer
#      commonName: test.example.com
#      dnsNames:
#        - test.example.com
#    EOF
#
#    # Check certificate status:
#    kubectl get certificate test-cert -n default
#    kubectl describe certificate test-cert -n default
#
#    # Check secret was created:
#    kubectl get secret test-cert-secret -n default
#
#    # Cleanup:
#    kubectl delete certificate test-cert -n default
#    kubectl delete clusterissuer test-selfsigned

---
# Troubleshooting
#
# Issue: cert-manager pods not starting
# Solution:
#   - Check node resources: kubectl top nodes
#   - Check pod events: kubectl describe pod -n cert-manager <pod-name>
#   - Check logs: kubectl logs -n cert-manager <pod-name>
#
# Issue: Webhook not ready
# Solution:
#   - Wait for webhook to be ready (can take 1-2 minutes)
#   - Check webhook service: kubectl get svc -n cert-manager cert-manager-webhook
#   - Check webhook endpoint: kubectl get endpoints -n cert-manager cert-manager-webhook
#
# Issue: CRDs not installed
# Solution:
#   - If using Helm, ensure installCRDs=true
#   - Manually install CRDs:
#     kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.crds.yaml
#
# Issue: Certificate not issued
# Solution:
#   - Check CertificateRequest: kubectl get certificaterequest -A
#   - Check issuer status: kubectl describe clusterissuer <issuer-name>
#   - Check cert-manager logs: kubectl logs -n cert-manager -l app=cert-manager

---
# Uninstall cert-manager
#
# Method 1: kubectl
#   kubectl delete -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
#
# Method 2: Helm
#   helm uninstall cert-manager -n cert-manager
#   kubectl delete namespace cert-manager
#
# Note: CRDs are not automatically deleted. To delete CRDs:
#   kubectl delete crd certificaterequests.cert-manager.io
#   kubectl delete crd certificates.cert-manager.io
#   kubectl delete crd challenges.acme.cert-manager.io
#   kubectl delete crd clusterissuers.cert-manager.io
#   kubectl delete crd issuers.cert-manager.io
#   kubectl delete crd orders.acme.cert-manager.io

