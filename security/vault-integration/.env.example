# HashiCorp Vault Integration - Environment Variables
#
# Copy this file to .env and update with your values:
#   cp .env.example .env
#
# Then source it before running commands:
#   source .env

# ============================================================================
# Kubernetes Configuration
# ============================================================================

# Kubernetes namespace for Redis Enterprise
export K8S_NAMESPACE="redis-enterprise"

# ============================================================================
# Vault Configuration
# ============================================================================

# Vault server address
export VAULT_ADDR="https://vault.example.com:8200"

# Vault token (for authentication)
export VAULT_TOKEN="your-vault-token"

# Vault Enterprise namespace (leave empty for Community Edition)
export VAULT_NAMESPACE=""

# Kubernetes auth method path in Vault
export AUTH_PATH="kubernetes"

# KV-v2 secret engine mount path
export VAULT_SECRET_ROOT="secret"

# Secret prefix (automatically includes K8S_NAMESPACE)
export VAULT_SECRET_PREFIX="redisenterprise-${K8S_NAMESPACE}"

# ============================================================================
# Vault Server Details (for operator ConfigMap)
# ============================================================================

# Vault server FQDN or IP address (without https://)
export VAULT_SERVER_FQDN="vault.example.com"

# Vault server port
export VAULT_SERVER_PORT="8200"

# ============================================================================
# TLS Configuration
# ============================================================================

# Path to Vault CA certificate file
export VAULT_CA_CERT_FILE="/path/to/vault-ca.crt"

# ============================================================================
# Redis Enterprise Configuration
# ============================================================================

# Redis Enterprise cluster name
export REC_NAME="rec"

# Cluster admin username
export CLUSTER_USERNAME="admin@redis.com"

# Database name
export DATABASE_NAME="my-database"

# ============================================================================
# Vault Policy and Role Names (auto-generated)
# ============================================================================

# Vault policy name
export VAULT_POLICY_NAME="redisenterprise-${K8S_NAMESPACE}"

# Operator service account role
export OPERATOR_ROLE="redis-enterprise-operator-${K8S_NAMESPACE}"

# Cluster service account role
export CLUSTER_ROLE="redis-enterprise-${REC_NAME}-${K8S_NAMESPACE}"

# ============================================================================
# Vault Secret Paths (auto-generated)
# ============================================================================

# Admission controller TLS certificate
export ADMISSION_SECRET_PATH="${VAULT_SECRET_ROOT}/${VAULT_SECRET_PREFIX}/admission-tls"

# Cluster credentials
export CLUSTER_SECRET_PATH="${VAULT_SECRET_ROOT}/${VAULT_SECRET_PREFIX}/${REC_NAME}"

# Database password
export DATABASE_SECRET_PATH="${VAULT_SECRET_ROOT}/${VAULT_SECRET_PREFIX}/${DATABASE_NAME}"

# ============================================================================
# Helper Functions
# ============================================================================

# Function to verify Vault connectivity
vault_health_check() {
    echo "Checking Vault connectivity..."
    if [ -n "$VAULT_NAMESPACE" ]; then
        vault -namespace="$VAULT_NAMESPACE" status
    else
        vault status
    fi
}

# Function to list all Redis Enterprise secrets
vault_list_secrets() {
    echo "Listing all Redis Enterprise secrets..."
    if [ -n "$VAULT_NAMESPACE" ]; then
        vault -namespace="$VAULT_NAMESPACE" kv list "${VAULT_SECRET_ROOT}/${VAULT_SECRET_PREFIX}"
    else
        vault kv list "${VAULT_SECRET_ROOT}/${VAULT_SECRET_PREFIX}"
    fi
}

# Function to generate secure password
generate_password() {
    openssl rand -base64 32 | tr -d "=+/" | cut -c1-25
}

# ============================================================================
# Display Configuration
# ============================================================================

echo "========================================="
echo "Vault Integration Configuration"
echo "========================================="
echo "Kubernetes Namespace: $K8S_NAMESPACE"
echo "Vault Address: $VAULT_ADDR"
echo "Vault Namespace: ${VAULT_NAMESPACE:-<Community Edition>}"
echo "Auth Path: $AUTH_PATH"
echo "Secret Root: $VAULT_SECRET_ROOT"
echo "Secret Prefix: $VAULT_SECRET_PREFIX"
echo "Vault Server FQDN: $VAULT_SERVER_FQDN"
echo "Cluster Name: $REC_NAME"
echo "========================================="
echo ""
echo "Run 'vault_health_check' to verify Vault connectivity"
echo "Run 'vault_list_secrets' to list all secrets"
echo "Run 'generate_password' to generate a secure password"
echo ""

