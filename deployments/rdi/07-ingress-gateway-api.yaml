# ============================================================================
# RDI API - Gateway API Configuration
# ============================================================================
#
# Exposes RDI API via Kubernetes Gateway API (modern alternative to Ingress)
#
# Prerequisites:
# 1. Gateway API CRDs installed
# 2. Gateway controller installed (e.g., NGINX Gateway Fabric)
# 3. Gateway resource created
# 4. cert-manager installed (for TLS)
#
# ============================================================================

---
# HTTPRoute for RDI API
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: rdi-api
  namespace: rdi
  labels:
    app: rdi
    component: api
spec:
  parentRefs:
    - name: redis-gateway
      namespace: nginx-gateway
      sectionName: https
  
  hostnames:
    - "rdi-api.example.com"
  
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: rdi-api
          port: 8080
      
      # Timeouts for long-running operations
      timeouts:
        request: 5m
        backendRequest: 5m

---
# HTTPRoute for RDI Metrics
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: rdi-metrics
  namespace: rdi
  labels:
    app: rdi
    component: metrics
spec:
  parentRefs:
    - name: redis-gateway
      namespace: nginx-gateway
      sectionName: https
  
  hostnames:
    - "rdi-metrics.example.com"
  
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /metrics
      backendRefs:
        - name: rdi-metric-exporter
          port: 8081

---
# ReferenceGrant to allow Gateway in different namespace
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: rdi-gateway-access
  namespace: rdi
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: nginx-gateway
  to:
    - group: ""
      kind: Service

---
# TLSRoute for RDI API (alternative with TLS passthrough)
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TLSRoute
metadata:
  name: rdi-api-tls
  namespace: rdi
  labels:
    app: rdi
    component: api
spec:
  parentRefs:
    - name: redis-gateway
      namespace: nginx-gateway
      sectionName: tls
  
  hostnames:
    - "rdi-api.example.com"
  
  rules:
    - backendRefs:
        - name: rdi-api
          port: 8080

---
# Verification Commands
# ============================================================================
# 1. Apply Gateway API resources:
#    kubectl apply -f 07-ingress-gateway-api.yaml
#
# 2. Check HTTPRoutes:
#    kubectl get httproute -n rdi
#    kubectl describe httproute rdi-api -n rdi
#
# 3. Check route status:
#    kubectl get httproute rdi-api -n rdi -o jsonpath='{.status.parents[0].conditions}'
#
# 4. Test RDI API:
#    curl https://rdi-api.example.com/health
#
# 5. Test metrics:
#    curl https://rdi-metrics.example.com/metrics/collector-source
#    curl https://rdi-metrics.example.com/metrics/rdi
#
# 6. Add to Redis Insight:
#    - Open Redis Insight
#    - Go to RDI section
#    - Add connection: https://rdi-api.example.com
# ============================================================================

---
# Example: Create Gateway (if not exists)
# ============================================================================
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: redis-gateway
#   namespace: nginx-gateway
# spec:
#   gatewayClassName: nginx
#   listeners:
#     - name: http
#       protocol: HTTP
#       port: 80
#       allowedRoutes:
#         namespaces:
#           from: All
#     
#     - name: https
#       protocol: HTTPS
#       port: 443
#       tls:
#         mode: Terminate
#         certificateRefs:
#           - kind: Secret
#             name: redis-gateway-tls
#       allowedRoutes:
#         namespaces:
#           from: All
# ============================================================================

